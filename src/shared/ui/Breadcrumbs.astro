---
// src/components/Breadcrumbs.astro
// Хлебные крошки для внутренних страниц.

export interface BreadcrumbItem {
  label: string
  href?: string
}

export interface Props {
  items: BreadcrumbItem[]
}

const { items } = Astro.props

// Базовый URL сайта нужен для JSON-LD (абсолютные ссылки).
const siteUrl = (Astro.site ? Astro.site.toString() : 'https://ibiza.ru').replace(/\/$/, '')

function toAbsoluteUrl(urlOrPath: string): string {
  try {
    return new URL(urlOrPath).toString()
  } catch {
    return new URL(urlOrPath, siteUrl + '/').toString()
  }
}

// Текущий URL страницы используем для последнего элемента, если у него нет href.
const currentUrl = new URL(Astro.url.pathname, siteUrl + '/').toString()

// JSON-LD требует item.url для каждого уровня.
const breadcrumbJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: items.map((item, idx) => ({
    '@type': 'ListItem',
    position: idx + 1,
    name: item.label,
    item: item.href ? toAbsoluteUrl(item.href) : currentUrl,
  })),
}

// Экранируем "<", чтобы случайно не закрыть </script>.
const breadcrumbJsonLdString = JSON.stringify(breadcrumbJsonLd).replace(/</g, '\\u003c')
---

<nav class="breadcrumbs text-sm">
  <ul>
    {items.map((item, idx) => (
      <li>
        {item.href ? (
          <a href={item.href}>{item.label}</a>
        ) : (
          <span aria-current={idx === items.length - 1 ? 'page' : undefined}>{item.label}</span>
        )}
      </li>
    ))}
  </ul>
</nav>

<script type="application/ld+json" is:inline set:html={breadcrumbJsonLdString} />
