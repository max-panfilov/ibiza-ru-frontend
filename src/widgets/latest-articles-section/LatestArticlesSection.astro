---
// src/widgets/latest-articles-section/LatestArticlesSection.astro
// Блок «Последние статьи» на главной.

import { articleRepository } from '@/entities/article/api/articleRepository'
import { formatDateRu } from '@/shared/lib/formatDate'
import { logApiError } from '@/shared/api/errors'
import { getTransformedDirectusAssetUrl } from '@/shared/lib/imageHelpers'
import type { Article } from '@/entities/article/model/types'

let latest: Article[] = []
try {
  const articles = await articleRepository.getAll({ limit: 3 })
  latest = articles
} catch (error) {
  logApiError(error)
}
---

<section class="container mx-auto px-4 py-14">
  <h2 class="text-4xl font-bold mb-10 text-center">Последние статьи</h2>

  {latest.length === 0 ? (
    <div class="text-center text-base-content/60 py-12">Нет статей для отображения</div>
  ) : (
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {latest.map((a) => (
          <a
            href={`/articles/${a.code}`}
            class="card bg-base-100 border border-base-200 overflow-hidden hover:shadow-md transition-shadow"
          >
            <figure class="aspect-[16/9]">
              <img
                src={a.coverImage?.url ? getTransformedDirectusAssetUrl(a.coverImage.url, { width: 900, quality: 70, format: 'webp', fit: 'cover' }) : '/placeholder.jpg'}
                alt={a.title}
                class="h-full w-full object-cover"
                loading="lazy"
              />
            </figure>
            <div class="card-body">
              <h3 class="card-title leading-snug">{a.title}</h3>
              {a.publishedAt ? (
                <div class="text-sm text-base-content/60">{formatDateRu(a.publishedAt)}</div>
              ) : null}
              {/* Краткое описание статьи с переносами строк, при этом оставляем line-clamp */}
              <p class="text-base-content/70 line-clamp-3 multiline-text">{a.summary}</p>
            </div>
          </a>
        ))}
      </div>

      <div class="text-center">
        <a href="/articles" class="btn btn-outline gap-2">
          <span>Все статьи</span>
          <span aria-hidden="true">→</span>
        </a>
      </div>
    </div>
  )}
</section>
