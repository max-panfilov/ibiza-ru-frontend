---
// src/pages/articles/index.astro

import SiteLayout from '../../layouts/SiteLayout.astro'
import Breadcrumbs from '@/shared/ui/Breadcrumbs.astro'
import { articleRepository } from '@/entities/article/api/articleRepository'
import { formatDateRu } from '@/shared/lib/formatDate'
import { logApiError } from '@/shared/api/errors'
import { getTransformedDirectusAssetUrl } from '@/shared/lib/imageHelpers'
import type { Article } from '@/entities/article/model/types'

let articles: Article[] = []
let error: string | null = null

try {
  articles = await articleRepository.getAll()
} catch (err) {
  logApiError(err)
  error = 'Не удалось загрузить список статей'
}

// SEO: JSON-LD для страницы-коллекции статей.
// SEO: og:image для страницы списка. Берём cover первой статьи (если есть).
const ogImage = articles[0]?.coverImage?.url

const ogImageTransformed = ogImage
  ? getTransformedDirectusAssetUrl(ogImage, { width: 1200, quality: 75, format: 'webp', fit: 'cover' })
  : undefined

const articlesStructuredData = [
  {
    '@context': 'https://schema.org',
    '@type': 'CollectionPage',
    name: 'Статьи об Ибице',
    url: 'https://ibiza.ru/articles',
    description: 'Интересные статьи, обзоры и рекомендации об отдыхе на Ибице (прототип)',
  },
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: 'Список статей',
    itemListElement: articles.map((a, idx) => ({
      '@type': 'ListItem',
      position: idx + 1,
      item: {
        '@type': 'BlogPosting',
        headline: a.title,
        url: `https://ibiza.ru/articles/${a.code}`,
      },
    })),
  },
]
---

<SiteLayout
  title="Статьи об Ибице | Ibiza.ru"
  description="Интересные статьи, обзоры и рекомендации об отдыхе на Ибице (прототип)"
  canonical="https://ibiza.ru/articles"
  ogImage={ogImageTransformed}
  structuredData={articlesStructuredData}
>
  <div class="container mx-auto px-4 py-10">
    <div class="mb-6">
      <Breadcrumbs items={[{ href: '/', label: 'Главная' }, { label: 'Статьи' }]} />
    </div>

    <div class="mb-8">
      <h1 class="text-3xl font-bold">Статьи об Ибице</h1>
      <p class="text-base-content/70 mt-2">Интересные статьи, обзоры и рекомендации об отдыхе на Ибице</p>
    </div>

    {error ? (
      <div class="alert alert-error">
        <span>{error}</span>
      </div>
    ) : null}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {articles.length === 0 ? (
        <div class="col-span-full text-center text-base-content/60 py-12">Нет статей для отображения</div>
      ) : (
        articles.map((a) => (
          <a
            href={`/articles/${a.code}`}
            class="card bg-base-100 border border-base-200 overflow-hidden hover:shadow-md transition-shadow"
          >
            <figure class="aspect-[16/9]">
              <img
                src={a.coverImage?.url ? getTransformedDirectusAssetUrl(a.coverImage.url, { width: 900, quality: 70, format: 'webp', fit: 'cover' }) : '/placeholder.jpg'}
                alt={a.title}
                class="h-full w-full object-cover"
                loading="lazy"
              />
            </figure>
            <div class="card-body">
              <h2 class="card-title leading-snug">{a.title}</h2>
              {a.publishedAt ? (
                <div class="text-sm text-base-content/60">{formatDateRu(a.publishedAt)}</div>
              ) : null}
              {/* Краткое описание статьи: учитываем переводы строк, если редактор их использует */}
              <p class="text-base-content/70 multiline-text">{a.summary}</p>
            </div>
          </a>
        ))
      )}
    </div>
  </div>
</SiteLayout>
