---
// src/pages/beaches/[code].astro

import SiteLayout from '../../layouts/SiteLayout.astro'
import Breadcrumbs from '@/shared/ui/Breadcrumbs.astro'
import ImageCarousel from '@/shared/ui/ImageCarousel.astro'
import PlaceMapModal from '@/widgets/place-map/PlaceMapModal.astro'
import { beachRepository } from '@/entities/beach/api/beachRepository'
import { renderArticleMarkdownToHtml, renderMarkdownWithInlineImagesToHtml } from '@/features/article-content/lib/renderArticleMarkdown'
import ParamBadges from '@/shared/ui/ParamBadges.astro'
import { logApiError } from '@/shared/api/errors'
import type { Beach } from '@/entities/beach/model/types'

// Для путей берём только коды пляжей, галерею и прочие данные подтягиваем через getByCode
export async function getStaticPaths() {
  try {
    const beaches = await beachRepository.getAll({ fields: ['code'] })
    return beaches.map((beach) => ({
      params: { code: beach.code },
    }))
  } catch (error) {
    // В PROD сборке лучше упасть, чем незаметно сгенерировать 0 страниц.
    logApiError(error)
    if (import.meta.env.PROD) throw error
    return []
  }
}

const { code } = Astro.params as { code: string }
let beach: Beach

try {
  beach = await beachRepository.getByCode(code)
} catch (error) {
  logApiError(error)
  throw error
}

// SEO: og:image берём из обложки (или первого изображения).
const ogImage = beach.coverImage?.url ?? beach.images?.[0]?.url

// Описание приходит из Directus как markdown — рендерим в HTML безопасным пайплайном (без raw HTML).
const markdownHasSeparators = /(^|\n)\s*---\s*(\n|$)/.test(beach.description ?? '')
const inlineImages = (beach.images ?? []).map((img) => ({
  url: img.url,
  alt: img.alt ?? beach.title,
}))
const useInlineImages = markdownHasSeparators && inlineImages.length > 0
const descriptionHtml = beach.description
  ? useInlineImages
    ? await renderMarkdownWithInlineImagesToHtml(beach.description, inlineImages)
    : await renderArticleMarkdownToHtml(beach.description)
  : ''

// SEO: JSON-LD для пляжа. Берём максимально универсальный тип TouristAttraction.
const beachStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'TouristAttraction',
  name: beach.title,
  url: `https://ibiza.ru/beaches/${beach.code}`,
  ...(beach.description ? { description: beach.description } : {}),
  ...(ogImage ? { image: ogImage } : {}),
  ...(beach.location ? { address: beach.location } : {}),
  ...(typeof beach.latitude === 'number' && typeof beach.longitude === 'number'
    ? {
        geo: {
          '@type': 'GeoCoordinates',
          latitude: beach.latitude,
          longitude: beach.longitude,
        },
      }
    : {}),
}
---

<SiteLayout
  title={`${beach.title} | Пляжи | Ibiza.ru`}
  description={beach.description}
  canonical={`https://ibiza.ru/beaches/${beach.code}`}
  ogImage={ogImage}
  structuredData={beachStructuredData}
>
  <div class="container mx-auto px-4 py-10">
    <div class="mb-6">
      <Breadcrumbs
        items={[
          { href: '/', label: 'Главная' },
          { href: '/beaches', label: 'Пляжи' },
          { label: beach.title },
        ]}
      />
    </div>

    <!-- Заголовок + быстрая инфа сверху (до слайдшоу) -->
    <header class="mb-6">
      <h1 class="text-3xl font-bold">{beach.title}</h1>

      {/* Адрес/локация пляжа сразу под названием, без плашки */}
      {beach.location ? (
        <div class="mt-2 text-base-content/70">
          <PlaceMapModal
            id={`beach-${beach.code}`}
            title={beach.title}
            label={beach.location}
            latitude={beach.latitude}
            longitude={beach.longitude}
            triggerClass="link link-hover"
          />
        </div>
      ) : null}

      {/* Параметры пляжа (M2M): характеристики/удобства */}
      {beach.facilities?.length ? <ParamBadges values={beach.facilities} /> : null}

      {/* Короткое описание пляжа с сохранением переводов строк */}
      {beach.description ? (
        <div class="mt-2 text-base-content/70 article-content" set:html={descriptionHtml} />
      ) : null}
    </header>

    <!-- Крупное фото/галерея: слайдер (Embla) -->
    {useInlineImages ? null : (
      <ImageCarousel
        id={`beach-carousel-${beach.code}`}
        images={beach.images?.map((img) => img.url) ?? (beach.coverImage?.url ? [beach.coverImage.url] : ['/placeholder.jpg'])}
        alt={beach.title}
      />
    )}

  </div>
</SiteLayout>
