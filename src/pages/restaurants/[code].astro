---
// src/pages/restaurants/[code].astro

import SiteLayout from '../../layouts/SiteLayout.astro'
import Breadcrumbs from '@/shared/ui/Breadcrumbs.astro'
import ImageCarousel from '@/shared/ui/ImageCarousel.astro'
import PlaceMap from '@/widgets/place-map/PlaceMap.astro'
import { restaurantRepository } from '@/entities/restaurant/api/restaurantRepository'
import { logApiError } from '@/shared/api/errors'
import type { Restaurant } from '@/entities/restaurant/model/types'

// Генерируем только коды ресторанов, а полные данные подтягиваем через getByCode
export async function getStaticPaths() {
  try {
    const restaurants = await restaurantRepository.getAll({ fields: ['code'] })
    return restaurants.map((restaurant) => ({
      params: { code: restaurant.code },
    }))
  } catch (error) {
    // В PROD сборке лучше упасть, чем незаметно сгенерировать 0 страниц.
    logApiError(error)
    if (import.meta.env.PROD) throw error
    return []
  }
}

const { code } = Astro.params as { code: string }
let restaurant: Restaurant

try {
  restaurant = await restaurantRepository.getByCode(code)
} catch (error) {
  logApiError(error)
  throw error
}

// SEO: og:image берём из обложки (или первого изображения).
const ogImage = restaurant.coverImage?.url ?? restaurant.images?.[0]?.url

// SEO: JSON-LD для ресторана.
const restaurantStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'Restaurant',
  name: restaurant.title,
  url: `https://ibiza.ru/restaurants/${restaurant.code}`,
  ...(restaurant.description ? { description: restaurant.description } : {}),
  ...(ogImage ? { image: ogImage } : {}),
  ...(restaurant.address ? { address: restaurant.address } : {}),
  ...(typeof restaurant.latitude === 'number' && typeof restaurant.longitude === 'number'
    ? {
        geo: {
          '@type': 'GeoCoordinates',
          latitude: restaurant.latitude,
          longitude: restaurant.longitude,
        },
      }
    : {}),
}
---

<SiteLayout
  title={`${restaurant.title} | Рестораны | Ibiza.ru`}
  description={restaurant.description}
  canonical={`https://ibiza.ru/restaurants/${restaurant.code}`}
  ogImage={ogImage}
  structuredData={restaurantStructuredData}
>
  <div class="container mx-auto px-4 py-10">
    <div class="mb-6">
      <Breadcrumbs
        items={[
          { href: '/', label: 'Главная' },
          { href: '/restaurants', label: 'Рестораны' },
          { label: restaurant.title },
        ]}
      />
    </div>

    <!-- Заголовок + быстрая инфа сверху (до слайдшоу) -->
    <header class="mb-6">
      <h1 class="text-3xl font-bold">{restaurant.title}</h1>

      {/* Под заголовком: диапазон цен и адрес ресторана */}
      <div class="mt-3 flex flex-wrap gap-2 text-base-content/70 items-center">
        {restaurant.priceRange ? (
          <span class="badge badge-outline badge-lg shrink-0 whitespace-nowrap">{restaurant.priceRange}</span>
        ) : null}
        {restaurant.address ? <span>{restaurant.address}</span> : null}
      </div>

      {/* Далее — описание ресторана с поддержкой переводов строк */}
      {restaurant.description ? (
        <p class="mt-3 text-base-content/70 multiline-text">{restaurant.description}</p>
      ) : null}
    </header>

    <!-- Крупное фото/галерея: слайдер (Embla) -->
    <ImageCarousel
      id={`restaurant-carousel-${restaurant.code}`}
      images={restaurant.images?.map((img) => img.url) ?? (restaurant.coverImage?.url ? [restaurant.coverImage.url] : ['/placeholder.jpg'])}
      alt={restaurant.title}
    />

    <!-- Ниже: контакты и карта в одной колонке -->
    <div class="mt-10">

      <!-- Контактная информация ресторана -->
      <div class="mt-10">
        <div class="card bg-base-100 border border-base-200">
          <div class="card-body">
            <h3 class="card-title text-lg">Связаться с рестораном</h3>

            <dl class="mt-2 space-y-2">
              {restaurant.phone ? (
                <div class="flex gap-2">
                  <dt class="w-28 text-base-content/60">Телефон</dt>
                  <dd class="flex-1"><a class="link" href={`tel:${restaurant.phone}`}>{restaurant.phone}</a></dd>
                </div>
              ) : null}

              {restaurant.email ? (
                <div class="flex gap-2">
                  <dt class="w-28 text-base-content/60">Email</dt>
                  <dd class="flex-1"><a class="link" href={`mailto:${restaurant.email}`}>{restaurant.email}</a></dd>
                </div>
              ) : null}

              {restaurant.website ? (
                <div class="flex gap-2">
                  <dt class="w-28 text-base-content/60">Сайт</dt>
                  {/* Показываем полный адрес сайта без подписи "перейти" и закрываем от индексации */}
                  <dd class="flex-1">
                    <a class="link" href={restaurant.website} target="_blank" rel="noreferrer nofollow">
                      {restaurant.website}
                    </a>
                  </dd>
                </div>
              ) : null}
            </dl>
          </div>
        </div>
      </div>

      <!-- Карта -->
      <PlaceMap
        id={`restaurant-map-${restaurant.code}`}
        title={restaurant.title}
        latitude={restaurant.latitude}
        longitude={restaurant.longitude}
      />
    </div>
  </div>
</SiteLayout>
