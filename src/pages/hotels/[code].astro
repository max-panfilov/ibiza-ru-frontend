---
// src/pages/hotels/[code].astro

import SiteLayout from '../../layouts/SiteLayout.astro'
import Breadcrumbs from '@/shared/ui/Breadcrumbs.astro'
import ImageCarousel from '@/shared/ui/ImageCarousel.astro'
import PlaceMap from '@/widgets/place-map/PlaceMap.astro'
import { Icon } from 'astro-icon/components'
import { hotelRepository } from '@/entities/hotel/api/hotelRepository'
import { renderArticleMarkdownToHtml } from '@/features/article-content/lib/renderArticleMarkdown'
import { logApiError } from '@/shared/api/errors'
import type { Hotel } from '@/entities/hotel/model/types'

// Генерируем только коды отелей, без тяжёлых данных (галереи подтягиваем через getByCode)
export async function getStaticPaths() {
  try {
    const hotels = await hotelRepository.getAll({ fields: ['code'] })
    return hotels.map((hotel) => ({
      params: { code: hotel.code },
    }))
  } catch (error) {
    // В PROD сборке лучше упасть, чем незаметно сгенерировать 0 страниц.
    logApiError(error)
    if (import.meta.env.PROD) throw error
    return []
  }
}

const { code } = Astro.params as { code: string }
let hotel: Hotel

try {
  hotel = await hotelRepository.getByCode(code)
} catch (error) {
  logApiError(error)
  throw error
}

// SEO: og:image берём из обложки (или первого изображения).
const ogImage = hotel.coverImage?.url ?? hotel.images?.[0]?.url

// Описание приходит из Directus как markdown — рендерим в HTML безопасным пайплайном (без raw HTML).
const descriptionHtml = hotel.description ? await renderArticleMarkdownToHtml(hotel.description) : ''

// SEO: JSON-LD для отеля (минимально полезные поля).
const hotelStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'Hotel',
  name: hotel.title,
  url: `https://ibiza.ru/hotels/${hotel.code}`,
  ...(hotel.description ? { description: hotel.description } : {}),
  ...(ogImage ? { image: ogImage } : {}),
  ...(hotel.address ? { address: hotel.address } : {}),
  ...(typeof hotel.latitude === 'number' && typeof hotel.longitude === 'number'
    ? {
        geo: {
          '@type': 'GeoCoordinates',
          latitude: hotel.latitude,
          longitude: hotel.longitude,
        },
      }
    : {}),
}
---

<SiteLayout
  title={`${hotel.title} | Отели | Ibiza.ru`}
  description={hotel.description}
  canonical={`https://ibiza.ru/hotels/${hotel.code}`}
  ogImage={ogImage}
  structuredData={hotelStructuredData}
>
  <div class="container mx-auto px-4 py-10">
    <div class="mb-6">
      <Breadcrumbs
        items={[
          { href: '/', label: 'Главная' },
          { href: '/hotels', label: 'Отели' },
          { label: hotel.title },
        ]}
      />
    </div>

    <!-- Заголовок + быстрая инфа сверху (до слайдшоу) -->
    <header class="mb-6">
      <div class="flex flex-wrap items-center gap-3">
        <h1 class="text-3xl font-bold">{hotel.title}</h1>
        {typeof hotel.starRating === 'number' && hotel.starRating > 0 && (
          <span class="inline-flex items-center gap-0.5 text-yellow-400 whitespace-nowrap">
            {Array.from({ length: Math.min(5, Math.round(hotel.starRating)) }).map((_, i) => (
              <Icon name="lucide:star" class="icon-star-filled w-5 h-5" data-star-index={i} />
            ))}
          </span>
        )}
      </div>

      {/* Под заголовком: цена (плашка) и адрес текстом */}
      <div class="mt-3 flex flex-wrap gap-2 items-center text-base-content/70">
        {hotel.priceRange ? (
          <span class="badge badge-outline badge-lg shrink-0 whitespace-nowrap">{hotel.priceRange}</span>
        ) : null}
        {hotel.address ? <span>{hotel.address}</span> : null}
      </div>

      {/* Описание отеля: поддерживаем переводы строк через CSS-класс multiline-text */}
      {hotel.description ? (
        <div class="mt-3 text-base-content/70 article-content" set:html={descriptionHtml} />
      ) : null}
    </header>

    <!-- Крупное фото/галерея: слайдер (Embla) -->
    <ImageCarousel
      id={`hotel-carousel-${hotel.code}`}
      images={hotel.images?.map(img => img.url) ?? (hotel.coverImage?.url ? [hotel.coverImage.url] : ['/placeholder.jpg'])}
      alt={hotel.title}
    />

    <!-- Данные страницы в одну колонку -->
    <div class="mt-10">

      <!-- Пример блока «данные объекта» (после Directus здесь будут реальные поля) -->
      <div class="mt-10">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card bg-base-100 border border-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">Основная информация</h3>

              <dl class="mt-2 space-y-2">
                {hotel.address ? (
                  <div class="flex gap-2">
                    <dt class="w-28 text-base-content/60">Адрес</dt>
                    <dd class="flex-1">{hotel.address}</dd>
                  </div>
                ) : null}

                {hotel.checkIn || hotel.checkOut ? (
                  <div class="flex gap-2">
                    <dt class="w-28 text-base-content/60">Заезд/выезд</dt>
                    <dd class="flex-1">{hotel.checkIn ?? '—'} / {hotel.checkOut ?? '—'}</dd>
                  </div>
                ) : null}

                {hotel.phone ? (
                  <div class="flex gap-2">
                    <dt class="w-28 text-base-content/60">Телефон</dt>
                    <dd class="flex-1"><a class="link" href={`tel:${hotel.phone}`}>{hotel.phone}</a></dd>
                  </div>
                ) : null}

                {hotel.website ? (
                  <div class="flex gap-2">
                    <dt class="w-28 text-base-content/60">Сайт</dt>
                    <dd class="flex-1">
                      <a class="link" href={hotel.website} target="_blank" rel="noreferrer nofollow">
                        {hotel.website}
                      </a>
                    </dd>
                  </div>
                ) : null}
              </dl>
            </div>
          </div>

          <div class="card bg-base-100 border border-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">Удобства</h3>
              <div class="mt-2 flex flex-wrap gap-2">
                {(hotel.tags ?? []).length === 0 ? (
                  <span class="text-base-content/60">Пока нет данных</span>
                ) : (
                  (hotel.tags ?? []).map((t) => <span class="badge badge-outline">{t}</span>)
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Карта -->
      <PlaceMap
        id={`hotel-map-${hotel.code}`}
        title={hotel.title}
        latitude={hotel.latitude}
        longitude={hotel.longitude}
      />
    </div>
  </div>
</SiteLayout>
