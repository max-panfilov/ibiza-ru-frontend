---
// src/pages/clubs/[code].astro

import SiteLayout from '../../layouts/SiteLayout.astro'
import Breadcrumbs from '@/shared/ui/Breadcrumbs.astro'
import ImageCarousel from '@/shared/ui/ImageCarousel.astro'
import PlaceMapModal from '@/widgets/place-map/PlaceMapModal.astro'
import { clubRepository } from '@/entities/club/api/clubRepository'
import { renderArticleMarkdownToHtml, renderMarkdownWithInlineImagesToHtml } from '@/features/article-content/lib/renderArticleMarkdown'
import ParamBadges from '@/shared/ui/ParamBadges.astro'
import { logApiError } from '@/shared/api/errors'
import type { Club } from '@/entities/club/model/types'

// Генерация статических путей для SSG — только коды клубов, без тяжёлой галереи
export async function getStaticPaths() {
  try {
    const clubs = await clubRepository.getAll({ fields: ['code'] })
    return clubs.map((club) => ({
      params: { code: club.code },
    }))
  } catch (error) {
    // В PROD сборке лучше упасть, чем незаметно сгенерировать 0 страниц.
    logApiError(error)
    if (import.meta.env.PROD) throw error
    return []
  }
}

const { code } = Astro.params as { code: string }
let club: Club

try {
  club = await clubRepository.getByCode(code)
} catch (error) {
  logApiError(error)
  throw error
}

// SEO: og:image берём из обложки (или первого изображения).
const ogImage = club.coverImage?.url ?? club.images?.[0]?.url

// Анонс приходит из Directus как markdown — рендерим в HTML безопасным пайплайном (без raw HTML).
const markdownHasSeparators = /(^|\n)\s*---\s*(\n|$)/.test(club.description ?? '')
const inlineImages = (club.images ?? []).map((img) => ({
  url: img.url,
  alt: img.alt ?? club.title,
}))
const useInlineImages = markdownHasSeparators && inlineImages.length > 0
const descriptionHtml = club.description
  ? useInlineImages
    ? await renderMarkdownWithInlineImagesToHtml(club.description, inlineImages)
    : await renderArticleMarkdownToHtml(club.description)
  : ''

// SEO: JSON-LD для ночного клуба.
const clubStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'NightClub',
  name: club.title,
  url: `https://ibiza.ru/clubs/${club.code}`,
  ...(club.description ? { description: club.description } : {}),
  ...(ogImage ? { image: ogImage } : {}),
  ...(club.address ? { address: club.address } : {}),
  ...(typeof club.latitude === 'number' && typeof club.longitude === 'number'
    ? {
        geo: {
          '@type': 'GeoCoordinates',
          latitude: club.latitude,
          longitude: club.longitude,
        },
      }
    : {}),
}
---

<SiteLayout
  title={`${club.title} | Клубы | Ibiza.ru`}
  description={club.description}
  canonical={`https://ibiza.ru/clubs/${club.code}`}
  ogImage={ogImage}
  structuredData={clubStructuredData}
>
  <div class="container mx-auto px-4 py-10">
    <div class="mb-6">
      <Breadcrumbs
        items={[
          { href: '/', label: 'Главная' },
          { href: '/clubs', label: 'Клубы' },
          { label: club.title },
        ]}
      />
    </div>

    <!-- Заголовок + быстрая инфа сверху (до слайдшоу) -->
    <header class="mb-6">
      <h1 class="text-3xl font-bold">{club.title}</h1>

      {/* Под заголовком: прайс на вход (плашка) и адрес текстом рядом */}
      <div class="mt-3 flex flex-wrap gap-2 items-center text-base-content/70">
        {club.entryFee ? (
          <span class="badge badge-outline badge-lg shrink-0 whitespace-nowrap">{club.entryFee}</span>
        ) : club.priceRange ? (
          <span class="badge badge-outline badge-lg shrink-0 whitespace-nowrap">{club.priceRange}</span>
        ) : null}
        {/* Адрес кликабелен: карта открывается в модалке и инициализируется только после открытия (экономим API). */}
        {club.address ? (
          <PlaceMapModal
            id={`club-${club.code}`}
            title={club.title}
            label={club.address}
            latitude={club.latitude}
            longitude={club.longitude}
            triggerClass="link link-hover"
          />
        ) : null}
      </div>

      {/* Контакты: переносим в верхний блок, без подписей */}
      {club.phone || club.email || club.website ? (
        <div class="mt-3 flex flex-wrap items-center gap-3 text-base-content/70">
          {club.phone ? <a class="link" href={`tel:${club.phone}`}>{club.phone}</a> : null}
          {club.email ? <a class="link" href={`mailto:${club.email}`}>{club.email}</a> : null}
          {club.website ? (
            <a
              class="btn btn-outline btn-sm"
              href={`/out?to=${encodeURIComponent(club.website)}`}
              target="_blank"
              rel="noopener noreferrer nofollow"
            >
              перейти на сайт
            </a>
          ) : null}
        </div>
      ) : null}

      {/* Параметры клуба (M2M): музыкальные жанры */}
      {club.musicGenres?.length ? <ParamBadges values={club.musicGenres} /> : null}

      {/* Анонс клуба с сохранением переводов строк */}
      {club.description ? (
        <div class="mt-3 text-base-content/70 article-content" set:html={descriptionHtml} />
      ) : null}
    </header>

    <!-- Крупное фото/галерея: слайдер (Embla) -->
    {useInlineImages ? null : (
      <ImageCarousel
        id={`club-carousel-${club.code}`}
        images={club.images?.map((img) => img.url) ?? (club.coverImage?.url ? [club.coverImage.url] : ['/placeholder.jpg'])}
        alt={club.title}
      />
    )}

    <!-- Данные страницы в одну колонку -->
    <div class="mt-10">

      <!-- Пример блока «данные клуба» (как будет выглядеть после интеграции) -->
      <div class="mt-10">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card bg-base-100 border border-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">Основная информация</h3>

              <dl class="mt-2 space-y-2">
                {club.address ? (
                  <div class="flex gap-2">
                    <dt class="w-28 text-base-content/60">Адрес</dt>
                    <dd class="flex-1">{club.address}</dd>
                  </div>
                ) : null}

                {club.entryFee ? (
                  <div class="flex gap-2">
                    <dt class="w-28 text-base-content/60">Вход</dt>
                    <dd class="flex-1">{club.entryFee}</dd>
                  </div>
                ) : null}
              </dl>
            </div>
          </div>

          <div class="card bg-base-100 border border-base-200">
            <div class="card-body">
              <h3 class="card-title text-lg">Особенности</h3>
              <p class="mt-2 text-base-content/70">
                Здесь появятся данные о музыке, диджеях, типе публики и расписании событий.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</SiteLayout>
